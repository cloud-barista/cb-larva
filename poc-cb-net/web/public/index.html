<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cloud-Barista Network</title>

    <script src="/js/code/highcharts.js"></script>
    <script src="/js/code/highcharts-more.js"></script>
    <script src="/js/code/modules/exporting.js"></script>
    <script src="/js/code/modules/accessibility.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <link rel="stylesheet" href="/introspect/assets/css/main.css"/>

    <style type="text/css">
        .highcharts-figure, .highcharts-data-table table {
            min-width: 320px;
            max-width: 800px;
            margin: 1em auto;
        }

        .highcharts-data-table table {
            font-family: Verdana, sans-serif;
            border-collapse: collapse;
            border: 1px solid #EBEBEB;
            margin: 10px auto;
            text-align: center;
            width: 100%;
            max-width: 500px;
        }

        .highcharts-data-table caption {
            padding: 1em 0;
            font-size: 1.2em;
            color: #555;
        }

        .highcharts-data-table th {
            font-weight: 600;
            padding: 0.5em;
        }

        .highcharts-data-table td, .highcharts-data-table th, .highcharts-data-table caption {
            padding: 0.5em;
        }

        .highcharts-data-table thead tr, .highcharts-data-table tr:nth-child(even) {
            background: #f8f8f8;
        }

        .highcharts-data-table tr:hover {
            background: #f1f7ff;
        }

    </style>
</head>
<body>

<!-- Header -->
<header id="header">
    <div class="inner">
        <a href="index.html" class="logo">Cloud-Barista</a>
        <nav id="nav">
            <a href="/">Home</a>
            <a href="#cb-net-conf">cb-network</a>
            <a href="#cladnet-list">CLADNet</a>
            <a href="#cladnet-status">CLADNet status</a>
        </nav>
    </div>
</header>
<a href="#menu" class="navPanelToggle"><span class="fa fa-bars"></span></a>

<!-- Banner -->
<section id="banner">
    <div class="inner">
        <h1>The AdminWeb of Cloud-Barista Network</h1>
        <ul class="actions">
            <li><a href="#cb-net-conf" class="button alt">See AdminWeb</a></li>
        </ul>
    </div>
</section>

<!-- The configuration of cb-network -->
<section id="cb-net-conf" class="one">
    <div class="inner">
        <header>
            <h2 class="align-center">The configuration of Cloud-Barista Network (cb-network) </h2>
        </header>
        <div class="row">
            <div class="6u 12u$(xsmall)">
                <h4 class="align-center">Networking Rules</h4>
                <div class="table-wrapper">
                    <table>
                        <thead>
                        <tr>
                            <th class="align-center">Host ID</th>
                            <th class="align-center">Host IP CIDR Block</th>
                            <th class="align-center">Host IP Address</th>
                            <th class="align-center">Public IP</th>
                        </tr>
                        </thead>
                        <tbody id="net-rule-data">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="6u$ 12u$(xsmall)">
                <figure class="highcharts-figure">
                    <div id="container"></div>
                    <!--<p class="highcharts-description">
                        This chart shows the Cloud-Barista Network configuration by the packed bubble charts provided from
                        Highcharts.
                    </p>-->
                </figure>
            </div>
        </div>

    </div>
</section>

<!-- The list of cloud adaptive network (CLADNet)-->
<section id="cladnet-list" class="one">
    <div class="inner">
        <!--        <header> -->
        <!--            <h2 class="align-center">AdminWeb: cb-network creation</h2> -->
        <!--        </header> -->
        <div>
            <div>
                <h4 class="align-center">A list of Cloud Adaptive Network (CLADNet)</h4>
                <div class="table-wrapper">
                    <table>
                        <thead>
                        <tr>
                            <th class="align-center">ID</th>
                            <th class="align-center">Name</th>
                            <th class="align-center">IPv4 CIDR block</th>
                            <th class="align-center">Description</th>
                        </tr>
                        </thead>
                        <tbody id="cladnet-data">
                        <tr>
                            <td class="align-center">To</td>
                            <td class="align-center">be</td>
                            <td class="align-center">updated</td>
                            <td class="align-center">:)</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Table -->
<section id="cladnet-remote-control" class="one">
    <div class="inner">
        <header>
            <h4 class="align-center">Remote-control of CLADNet</h2>
        </header>
        <div>
            <div>
                <div>
                    <span>CLADNet: </span>
                    <div class="select-wrapper">
                        <select id="cladnet-id-for-remote-control" class="cladnet-id-dropdown-elem">
                            <option value="" selected disabled hidden>Nothing to choose</option>
                        </select>
                    </div>                    
                </div>
                <br/>
                <button type="button" onclick="resumeCLADNet()">Resume</button>
                <button type="button" onclick="suspendCLADNet()">Suspend</button>
            </div>
        </div>
    </div>
</section>

<!-- The creation interface of cloud adaptive network -->
<section id="cladnet-creation" class="one">
    <div class="inner">
        <div>
            <div>
                <h4 class="align-center">Create your CLADNet: Cloud Adoptive Network</h4>
                <div class="table-wrapper">
                    <table>
                        <tbody>
                        <tr>
                            <td class="align-center">Name</td>
                            <td class="align-center"><input type="text" id="cladnet-name"/>
                            </td>
                        </tr>
                        <tr>
                            <td class="align-center">Network (IPv4 CIDR block)</td>
                            <td class="align-center"><input type="text" id="cladnet-ipv4-network"/><span>(IP address / Subnet mask will be converted and provided)</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="align-center">Description</td>
                            <td class="align-center"><input type="text" id="cladnet-description"/></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <button type="button" onclick="createCLADNet()">Create</button>
            </div>
        </div>
    </div>
</section>

<!-- Table -->
<section id="cladnet-status" class="one">
    <div class="inner">
        <header>
            <h2 class="align-center">The CLADNet status: connectivity and latency</h2>
        </header>
        <div>
            <div>
                <div>
                    <span>CLADNet: </span>
                    <div class="select-wrapper">
                        <select id="cladnet-id" class="cladnet-id-dropdown-elem">
                            <option value="" selected disabled hidden>Nothing to choose</option>
                        </select>
                    </div>
                    <span>TrialCount: </span>
                    <div class="select-wrapper">
                        <select id="trial-count">
                            <option value="" selected disabled hidden>Choose here</option>
                            <option value="3">3</option>
                            <option value="5">5</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                </div>
                <br/>
                <button type="button" onclick="executeEvaluation()">Execute</button>
                <h4 class="align-center">CLADNet status table</h4>
                <div class="table-wrapper">
                    <table>
                        <thead>
                        <tr>
                            <th class="align-center">Source</th>
                            <th class="align-center">Destination</th>
                            <th class="align-center">Latency (ms)</th>
                        </tr>
                        </thead>
                        <tbody id="network-status-data">
                        </tbody>
                    </table>
                </div>
                <h4 class="align-center">CLADNet status chart</h4>
                <div id="sankey_multiple"></div>
            </div>
        </div>
    </div>
</section>

<!-- Table -->
<section>

</section>


<script type="text/javascript">
    function sendDataframe(type, text) {
        let dataFrame = {
            type: type,
            text: text
        };

        let dataframeStr = JSON.stringify(dataFrame)
        console.log("JSON String of dataFrame:");
        console.log(dataframeStr);

        // Send those to the AdminWeb server
        ws.send(dataframeStr);
    }

    function resumeCLADNet(){
        let cladnetID = document.getElementById('cladnet-id-for-remote-control').value;

        console.log("CLADNetID:" + cladnetID);
        
        // Build JSON data
        // Example:
        // {
        //      "CLADNetID": "xxx",
        //      "commandMessage": {
        //          "controlCommand": "xxx",
        //          "controlCommandOption": "xxx"
        //      }
        // }

        let message = JSON.stringify({
            CLADNetID: cladnetID,
            controlCommand: "resume",
            controlCommandOption: ""
        });

        sendDataframe("control-command", message);
    }

    function suspendCLADNet(){
        let cladnetID = document.getElementById('cladnet-id-for-remote-control').value;        

        console.log("CLADNetID:" + cladnetID);
        
        // Build JSON data
        // Example:
        // {
        //      "CLADNetID": "xxx",
        //      "commandMessage": {
        //          "controlCommand": "xxx",
        //          "controlCommandOption": "xxx"
        //      }
        // }

        let message = JSON.stringify({
            CLADNetID: cladnetID,
            controlCommand: "suspend",
            controlCommandOption: ""
        });

        sendDataframe("control-command", message);
        
    }

    function createCLADNet() {

        // Get the network (IPv4 CIDR block) and description to create CLADNet
        let elemCLADNetName = document.getElementById("cladnet-name");
        let elemCLADNetIPv4Network = document.getElementById("cladnet-ipv4-network");
        let elemCLADNetDescription = document.getElementById("cladnet-description");
        
        console.log("CLADNetName:" + elemCLADNetName.value);
        console.log("CLADNetIPv4Network:" + elemCLADNetIPv4Network.value);
        console.log("CLADNetDescription:" + elemCLADNetDescription.value);

        // Build JSON data
        // Example:
        // {
        //     "CLADNetID":"cladnet1",
        //     "IPv4Network":"xxx.xxx.xxx.xxx/xx",
        //     "gatewayIP": "xxx.xxx.xxx.1",
        //     "description": "xxxxx"
        // }

        let Spec = JSON.stringify({
            id: "",
            name: elemCLADNetName.value,
            ipv4AddressSpace: elemCLADNetIPv4Network.value,
            description: elemCLADNetDescription.value
        });

        sendDataframe("cladnet-specification", Spec);
    }

    function executeEvaluation() {

        // Reset network status data
        document.getElementById("network-status-data").innerHTML = '';

        // Reset Sankey's data and chart
        sankeyData = new google.visualization.DataTable();
        sankeyData.addColumn('string', 'From');
        sankeyData.addColumn('string', 'To');
        sankeyData.addColumn('number', 'Latency avg (ms)');
        sankeyChart = new google.visualization.Sankey(document.getElementById('sankey_multiple'));

        let cladnetID = document.getElementById('cladnet-id').value;
        let trialCount = document.getElementById('trial-count').value;

        console.log("CLADNetID:" + cladnetID);
        console.log("TrialCount:" + trialCount);

        // Build JSON data
        // !! To be updated
        // Example:
        // {
        //     "CLADNetID": "xxx",
        //     "trialCount": xxx
        // }

        let spec = JSON.stringify({
            CLADNetID: cladnetID,
            trialCount: parseInt(trialCount)
        });

        sendDataframe("test-specification", spec);
    }
</script>


<script type="text/javascript">

    let loc = window.location;
    let uri = 'ws:';

    if (loc.protocol === 'https:') {
        uri = 'wss:';
    }
    uri += '//' + loc.host;
    uri += '/ws';

    console.log("WS URI: " + uri);
    ws = new WebSocket(uri)

    ws.onopen = function () {
        console.log('Connected')
    }

    ws.onmessage = function (evt) {
        console.log("Data received: ");
        console.log(evt.data);
        let msg = JSON.parse(evt.data);
        console.log("Data parsed: ");
        console.log(msg);

        switch (msg.type) {
            case "CLADNetList":
                console.log("CLADNetList:");
                console.log(msg.text);
                let list = JSON.parse(msg.text);
                console.log("Parsed CLADNetList: ");
                console.log(list);

                updateCLADNetTable(list);

                updateCLADNetDropdownList(list);

                break;
            case "NetworkingRule":
                console.log("NetworkingRule:");
                console.log(msg.text);
                let rule = JSON.parse(msg.text);
                console.log("Parsed NetworkingRule: ");
                console.log(rule);

                // Data sample
                // data = "{\"hostID\":[\"2\"],\"hostIPv4Network\":[\"192.168.10.2/23\"],\"hostIPAddress\":[\"192.168.10.2\"],\"PublicIP\":[\"xxx.xxx.xxx.xxx\"]}";
                // {
                //     "CLADNetID":"cladnet1",
                //     "hostID": ["2", "5"],
                //     "hostIPv4Network": ["xxx.xxx.xxx.2/yy", "xxx.xxx.xxx.3/yy"],
                //     "hostIPAddress": ["xxx.xxx.xxx.2", "xxx.xxx.xxx.3"],
                //     "publicIPAddress": ["aaa.aaa.aaa.aaa", "bbb.bbb.bbb.bbb"]
                // };

                updateNetworkingRuleTable(rule);

                updateChartData(rule);

                break;

            case "NetworkStatus":
                console.log("NetworkStatus:");
                console.log(msg.text);
                let networkStatus = JSON.parse(msg.text);
                console.log("Parsed NetworkStatus: ");
                console.log(networkStatus);

                // Data sample
                // data = "{\"hostID\":[\"2\"],\"hostIPv4Network\":[\"192.168.10.2/23\"],\"hostIPAddress\":[\"192.168.10.2\"],\"PublicIP\":[\"xxx.xxx.xxx.xxx\"]}";
                // {
                //     "CLADNetID":"cladnet1",
                //     "hostID": ["2", "5"],
                //     "hostIPv4Network": ["xxx.xxx.xxx.2/yy", "xxx.xxx.xxx.3/yy"],
                //     "hostIPAddress": ["xxx.xxx.xxx.2", "xxx.xxx.xxx.3"],
                //     "publicIPAddress": ["aaa.aaa.aaa.aaa", "bbb.bbb.bbb.bbb"]
                // };
                updateSankeyChart(networkStatus.interHostNetworkStatus);
                updateNetworkStatusTable(networkStatus.interHostNetworkStatus);

                break;

            default:
                console.log("Unknown type of message");
        }

    }

    function updateCLADNetTable(list) {
        let elemCLADNetData = document.getElementById("cladnet-data");

        // This table show a list of Cloud Adaptive Network
        let tbody = '';
        for (let i = 0; i < list.length; i++) {
            tbody += ('<tr>' +
                '<td class="align-center">' + list[i].id + '</td>' +
                '<td class="align-center">' + list[i].name + '</td>' +
                '<td class="align-center">' + list[i].ipv4AddressSpace + '</td>' +
                '<td class="align-center">' + list[i].description + '</td>' +
                '</tr>');
        }
        elemCLADNetData.innerHTML = tbody;
    }

    function updateCLADNetDropdownList(list) {
        let elems = document.getElementsByClassName("cladnet-id-dropdown-elem");

        for (var i=0; i<elems.length; i++) {
            elems[i].innerHTML = '';
            elems[i].innerHTML += '<option value="" selected disabled hidden>Choose here</option>';

            for (let j = 0; j < list.length; j++) {
                elems[i].innerHTML += '<option value="' + list[j].id + '">' + list[j].id + '</option>';
            }
        }
    }

    function updateNetworkingRuleTable(json) {
        for (let i = 0; i < json.hostID.length; i++) {
            let elemRule = document.getElementById(json.hostID[i]);
            if (elemRule) {
                elemRule.children[0].innerText = json.hostID[i];
                elemRule.children[1].innerText = json.hostIPv4Network[i];
                elemRule.children[2].innerText = json.hostIPAddress[i];
                elemRule.children[3].innerText = json.publicIPAddress[i];
            } else {
                let elemNetworkingRuleData = document.getElementById("net-rule-data");
                elemNetworkingRuleData.innerHTML += ('<tr id="' + json.hostID[i] + '" class="' + json.CLADNetID + '">' +
                    '<td class="align-center">' + json.hostID[i] + '</td>' +
                    '<td class="align-center">' + json.hostIPv4Network[i] + '</td>' +
                    '<td class="align-center">' + json.hostIPAddress[i] + '</td>' +
                    '<td class="align-center">' + json.publicIPAddress[i] + '</td>' +
                    '</tr>');
            }
        }
    }

    function updateChartData(json) {

        // Check if the CLADNet is included.
        let includedCLADNet = false;
        let objIndex = -1;
        for (let i = 0; i < chartDataFrame.series.length; i++) {
            let objName = "CLADNet " + json.CLADNetID;
            if (chartDataFrame.series[i].name == objName) {
                includedCLADNet = true;
                objIndex = i;
                break;
            }
        }

        if (includedCLADNet) {
            let existingCLADNet = chartDataFrame.series[objIndex];
            for (let i = 0; i < json.hostID.length; i++) {
                let includedHost = false;
                for (let j = 0; j < existingCLADNet.data.length; j++) {
                    if (json.hostID[i] == existingCLADNet.data[j].name) {
                        includedHost = true;
                        existingCLADNet.data[j].network = json.hostIPv4Network[i] + " - " + json.publicIPAddress[i];
                        break;
                    }
                }
                if (!includedHost) {
                    existingCLADNet.data.push({
                        name: json.hostID[i],
                        value: Math.floor(Math.random() * 30 + 1),
                        network: json.hostIPv4Network[i] + " - " + json.publicIPAddress[i]
                    });
                }
            }
        } else {
            let obj = {
                name: "CLADNet " + json.CLADNetID,
                data: []
            };

            let len = json.hostID.length;
            for (let i = 0; i < len; i++) {
                obj.data.push({
                    name: json.hostID[i],
                    value: Math.floor(Math.random() * 30 + 1),
                    network: json.hostIPv4Network[i] + " - " + json.publicIPAddress[i]
                });
            }
            chartDataFrame.series.push(obj);
        }
        // Update chart
        Highcharts.chart('container', chartDataFrame);
    }

    function updateNetworkStatusTable(interHostNetworkStatus) {

        let elemCLADNetData = document.getElementById("network-status-data");

        let len = interHostNetworkStatus.length;
        console.log(len);

        // This table shows a list of the network status
        let tbody = '';
        for (let i = 0; i < len; i++) {
            let sourceIP = interHostNetworkStatus[i].sourceIP;
            let sourceID = interHostNetworkStatus[i].sourceID;
            let destinationIP = interHostNetworkStatus[i].destinationIP;
            let destinationID = interHostNetworkStatus[i].destinationID;
            let averageRTT = parseFloat(interHostNetworkStatus[i].averageRTT);
            let src = sourceIP + " (" + sourceID + ")";
            let des = destinationIP + " (" + destinationID + ")";
            let unitCalibration = 1000;

            tbody += ('<tr>' +
                '<td class="align-center">' + src + '</td>' +
                '<td class="align-center">' + des + '</td>' +
                '<td class="align-center">' + (averageRTT * unitCalibration).toFixed(2) + '</td>' +
                '</tr>');

        }

        elemCLADNetData.innerHTML += tbody;
    }

    function updateSankeyChart(interHostNetworkStatus) {
        let len = interHostNetworkStatus.length;

        console.log(len);

        let tempArray = [];
        for (let i = 0; i < len; i++) {
            let sourceIP = interHostNetworkStatus[i].sourceIP;
            // let sourceID = interHostNetworkStatus[i].sourceID;
            let destinationIP = interHostNetworkStatus[i].destinationIP;
            // let destinationID = interHostNetworkStatus[i].destinationID;
            let averageRTT = parseFloat(interHostNetworkStatus[i].averageRTT);
            let src = sourceIP; // + " (" + sourceID + ")";
            let des = destinationIP; // + " (" + destinationID + ")";
            let unitCalibration = 1000;
            tempArray.push([
                src,
                des,
                averageRTT * unitCalibration
            ]);
        }

        console.log(tempArray);
        sankeyData.addRows(tempArray);
        sankeyChart.draw(sankeyData, options);
    }

</script>

<script type="text/javascript">
    chartDataFrame = {
        chart: {
            type: 'packedbubble',
            height: '100%'
        },
        title: {
            text: 'The cb-network configuration'
        },
        tooltip: {
            useHTML: true,
            pointFormat: '<b>{point.name}:</b> {point.network}'
        },
        plotOptions: {
            packedbubble: {
                minSize: '20%',
                maxSize: '100%',
                zMin: 0,
                zMax: 1000,
                layoutAlgorithm: {
                    gravitationalConstant: 0.05,
                    splitSeries: true,
                    seriesInteraction: false,
                    dragBetweenSeries: true,
                    parentNodeLimit: true
                },
                dataLabels: {
                    enabled: true,
                    format: '{point.name}',
                    filter: {
                        property: 'y',
                        operator: '>',
                        value: 0
                    },
                    style: {
                        color: 'black',
                        textOutline: 'none',
                        fontWeight: 'normal'
                    }
                }
            }
        },
        series: []
    };

</script>

<script type="text/javascript">
    google.charts.load("current", {packages: ["sankey"]});
    // google.charts.setOnLoadCallback(drawChart);

    // Set chart options
    let colors = ['#8ec4e0', '#8ccd53', '#fc8483', '#f8b155',
        '#bf98d2', '#fdfd82', '#1372b3', '#25a11d'];

    let options = {
        height: 400,
        sankey: {
            node: {
                label: {
                    fontName: 'Times-Roman',
                    fontSize: 13,
                    // color: '#871b47',
                    bold: false,
                    italic: false
                },
                nodePadding: 60,
                colors: colors
            },
            link: {
                colorMode: 'gradient',
                colors: colors,
                color: {
                    stroke: '#b6b6b6',
                    strokeWidth: 0.5
                }
            }
        }
    };
    let sankeyData;
    let sankeyChart;

    // function drawChart() {
    //     sankeyData = new google.visualization.DataTable();
    //     sankeyData.addColumn('string', 'From');
    //     sankeyData.addColumn('string', 'To');
    //     sankeyData.addColumn('number', 'Weight');
    //     // sankeyData.addRows([[]]);
    //     sankeyChart = new google.visualization.Sankey(document.getElementById('sankey_multiple'));
    //     // sankeyChart.draw(sankeyData, options);
    // }
</script>

<!-- Scripts -->
<script src="/introspect/assets/js/jquery.min.js"></script>
<script src="/introspect/assets/js/skel.min.js"></script>
<script src="/introspect/assets/js/util.js"></script>
<script src="/introspect/assets/js/main.js"></script>

</body>
</html>
