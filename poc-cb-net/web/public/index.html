<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cloud-Barista Network</title>

    <script src="/js/code/highcharts.js"></script>
    <script src="/js/code/highcharts-more.js"></script>
    <script src="/js/code/modules/exporting.js"></script>
    <script src="/js/code/modules/accessibility.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/flow.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>

    <link rel="stylesheet" href="/introspect/assets/css/main.css"/>

    <style type="text/css">
        .highcharts-figure, .highcharts-data-table table {
            min-width: 320px;
            max-width: 800px;
            margin: 1em auto;
        }

        .highcharts-data-table table {
            font-family: Verdana, sans-serif;
            border-collapse: collapse;
            border: 1px solid #EBEBEB;
            margin: 10px auto;
            text-align: center;
            width: 100%;
            max-width: 500px;
        }

        .highcharts-data-table caption {
            padding: 1em 0;
            font-size: 1.2em;
            color: #555;
        }

        .highcharts-data-table th {
            font-weight: 600;
            padding: 0.5em;
        }

        .highcharts-data-table td, .highcharts-data-table th, .highcharts-data-table caption {
            padding: 0.5em;
        }

        .highcharts-data-table thead tr, .highcharts-data-table tr:nth-child(even) {
            background: #f8f8f8;
        }

        .highcharts-data-table tr:hover {
            background: #f1f7ff;
        }

    </style>

    <style type="text/css">
        #chartdiv {
            width: 100%;
            height: 800px;
        }
    </style>
</head>
<body>

<!-- Header -->
<header id="header">
    <div class="inner">
        <a href="index.html" class="logo">Cloud-Barista</a>
        <nav id="nav">
            <a href="/">Home</a>
            <a href="#cladnet-list">Cloud Adaptive Network</a>
            <a href="#cladnet-conf">Configuration</a>            
            <a href="#cladnet-status">Status</a>
        </nav>
    </div>
</header>
<a href="#menu" class="navPanelToggle"><span class="fa fa-bars"></span></a>

<!-- Banner -->
<section id="banner">
    <div class="inner">
        <h1>The AdminWeb of Cloud-Barista Network</h1>
        <ul class="actions">
            <li><a href="#cladnet-conf" class="button alt">See AdminWeb</a></li>
        </ul>
    </div>
</section>

<!-- The list of cloud adaptive network (CLADNet)-->
<section id="cladnet-list" class="one">
    <div class="inner">
        <header>
        <h2 class="align-center">CLADNet: Cloud Adaptive Network for Multi-cloud</h2>
        </header>
        <div>
            <div>
                <h4 class="align-center">Cloud Adaptive Network list</h4>
                <div class="table-wrapper">
                    <table>
                        <thead>
                        <tr>
                            <th class="align-center">ID</th>
                            <th class="align-center">Name</th>
                            <th class="align-center">IPv4 CIDR block</th>
                            <th class="align-center">Description</th>
                        </tr>
                        </thead>
                        <tbody id="cladnet-data">
                        <tr>
                            <td class="align-center">To</td>
                            <td class="align-center">be</td>
                            <td class="align-center">updated</td>
                            <td class="align-center">:)</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div>
                <h4 class="align-center">Create your Cloud Adaptive Network</h4>
                <div class="table-wrapper">
                    <table>
                        <tbody>
                        <tr>
                            <td class="align-center">Name</td>
                            <td class="align-center"><input type="text" id="cladnet-name"/>
                            </td>
                        </tr>
                        <tr>
                            <td class="align-center">Network (IPv4 CIDR block)</td>
                            <td class="align-center"><input type="text" id="cladnet-ipv4-network"/><span>(IP address / Subnet mask will be converted and provided)</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="align-center">Description</td>
                            <td class="align-center"><input type="text" id="cladnet-description"/></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <button type="button" onclick="createCLADNet()">Create</button>
            </div>
        </div>
    </div>
</section>

<!-- The configuration of cb-network -->
<section id="cladnet-conf" class="one">
    <div class="inner">
        <header>
            <h2 class="align-center">Cloud Adaptive Network configuration</h2>
        </header>
        <div class="row">
            <div class="7u 12u$(xsmall)">
                <figure class="highcharts-figure">
                    <div id="container"></div>
                    <!--<p class="highcharts-description">
                        This chart shows the Cloud-Barista Network configuration by the packed bubble charts provided from
                        Highcharts.
                    </p>-->
                </figure>
            </div>
            <div class="5u$ 12u$(xsmall)">                
                <h4 class="align-center">Remote-control</h4>
                <div>
                    <div>
                        <div>
                            <span>CLADNet ID: </span>
                            <div class="select-wrapper">
                                <select id="cladnet-id-for-remote-control" class="cladnet-id-dropdown-elem">
                                    <option value="" selected disabled hidden>Nothing to choose</option>
                                </select>
                            </div>                    
                        </div>
                        <br/>
                        <button type="button" onclick="resumeCLADNet()">Resume</button>
                        <button type="button" onclick="suspendCLADNet()">Suspend</button>
                    </div>
                </div>
            </div>
        </div>
        <br/>
        <div>
            <h4 class="align-center">Networking rule</h4>
            <div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                        <tr>
                            <th class="align-center">Host ID</th>
                            <th class="align-center">Host IP CIDR Block</th>
                            <th class="align-center">Host IP Address</th>
                            <th class="align-center">Public IP</th>
                            <th class="align-center">State</th>
                        </tr>
                        </thead>
                        <tbody id="net-rule-data">
                        </tbody>
                    </table>
                </div>
            </div>   
        </div>
    </div>
</section>

<!-- Table -->
<section id="cladnet-status" class="one">
    <div class="inner">
        <header>
            <h2 class="align-center">The status Cloud Adaptive Network: connectivity and latency</h2>
        </header>
        <div>
            <div>
                <div>
                    <span>CLADNet ID: </span>
                    <div class="select-wrapper">
                        <select id="cladnet-id" class="cladnet-id-dropdown-elem">
                            <option value="" selected disabled hidden>Nothing to choose</option>
                        </select>
                    </div>
                    <span>TrialCount: </span>
                    <div class="select-wrapper">
                        <select id="trial-count">
                            <option value="" selected disabled hidden>Choose here</option>
                            <option value="3">3</option>
                            <option value="5">5</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                </div>
                <br/>
                <button type="button" onclick="executeEvaluation()">Execute</button>
                <h4 class="align-center">Status table</h4>
                <div class="table-wrapper">
                    <table>
                        <thead>
                        <tr>
                            <th class="align-center">Source</th>
                            <th class="align-center">Destination</th>
                            <th class="align-center">Latency (ms)</th>
                        </tr>
                        </thead>
                        <tbody id="network-status-data">
                        </tbody>
                    </table>
                </div>
                <h4 class="align-center">Status chart</h4>
                <div id="chartdiv"></div>
            </div>
        </div>
    </div>
</section>

<!-- Table -->
<section>

</section>


<script type="text/javascript">
    function sendDataframe(type, text) {
        let dataFrame = {
            type: type,
            text: text
        };

        let dataframeStr = JSON.stringify(dataFrame)
        console.log("JSON String of dataFrame:");
        console.log(dataframeStr);

        // Send those to the AdminWeb server
        ws.send(dataframeStr);
    }

    function resumeCLADNet(){
        let cladnetID = document.getElementById('cladnet-id-for-remote-control').value;

        console.log("CLADNetID:" + cladnetID);
        
        // Build JSON data
        // Example:
        // {
        //      "CLADNetID": "xxx",
        //      "commandMessage": {
        //          "controlCommand": "xxx",
        //          "controlCommandOption": "xxx"
        //      }
        // }

        let message = JSON.stringify({
            CLADNetID: cladnetID,
            controlCommand: "resume",
            controlCommandOption: ""
        });

        sendDataframe("control-command", message);
    }

    function suspendCLADNet(){
        let cladnetID = document.getElementById('cladnet-id-for-remote-control').value;        

        console.log("CLADNetID:" + cladnetID);
        
        // Build JSON data
        // Example:
        // {
        //      "CLADNetID": "xxx",
        //      "commandMessage": {
        //          "controlCommand": "xxx",
        //          "controlCommandOption": "xxx"
        //      }
        // }

        let message = JSON.stringify({
            CLADNetID: cladnetID,
            controlCommand: "suspend",
            controlCommandOption: ""
        });

        sendDataframe("control-command", message);
        
    }

    function createCLADNet() {

        // Get the network (IPv4 CIDR block) and description to create CLADNet
        let elemCLADNetName = document.getElementById("cladnet-name");
        let elemCLADNetIPv4Network = document.getElementById("cladnet-ipv4-network");
        let elemCLADNetDescription = document.getElementById("cladnet-description");
        
        console.log("CLADNetName:" + elemCLADNetName.value);
        console.log("CLADNetIPv4Network:" + elemCLADNetIPv4Network.value);
        console.log("CLADNetDescription:" + elemCLADNetDescription.value);

        // Build JSON data
        // Example:
        // {
        //     "CLADNetID":"cladnet1",
        //     "IPv4Network":"xxx.xxx.xxx.xxx/xx",
        //     "gatewayIP": "xxx.xxx.xxx.1",
        //     "description": "xxxxx"
        // }

        let Spec = JSON.stringify({
            id: "",
            name: elemCLADNetName.value,
            ipv4AddressSpace: elemCLADNetIPv4Network.value,
            description: elemCLADNetDescription.value
        });

        sendDataframe("cladnet-specification", Spec);
    }

    let networkStatusArray = [];
    function executeEvaluation() {

        // Reset network status data
        document.getElementById("network-status-data").innerHTML = '';
        // document.getElementById("chartdiv").innerHTML = '';
        networkStatusArray = [];
        
        let cladnetID = document.getElementById('cladnet-id').value;
        let trialCount = document.getElementById('trial-count').value;

        console.log("CLADNetID:" + cladnetID);
        console.log("TrialCount:" + trialCount);

        // Build JSON data
        // !! To be updated
        // Example:
        // {
        //     "CLADNetID": "xxx",
        //     "trialCount": xxx
        // }

        let spec = JSON.stringify({
            CLADNetID: cladnetID,
            trialCount: parseInt(trialCount)
        });

        sendDataframe("test-specification", spec);
    }
</script>


<script type="text/javascript">

    let loc = window.location;
    let uri = 'ws:';

    if (loc.protocol === 'https:') {
        uri = 'wss:';
    }
    uri += '//' + loc.host;
    uri += '/ws';

    console.log("WS URI: " + uri);
    ws = new WebSocket(uri)

    ws.onopen = function () {
        console.log('Connected')
    }

    ws.onmessage = function (evt) {
        console.log("Data received: ");
        console.log(evt.data);
        let msg = JSON.parse(evt.data);
        console.log("Data parsed: ");
        console.log(msg);

        switch (msg.type) {
            case "CLADNetList":
                console.log("CLADNetList:");
                console.log(msg.text);
                let list = JSON.parse(msg.text);
                console.log("Parsed CLADNetList: ");
                console.log(list);

                updateCLADNetTable(list);

                updateCLADNetDropdownList(list);

                break;
            case "peer":
                console.log("peer:");
                console.log(msg.text);
                let peerObj = JSON.parse(msg.text);
                console.log("Parsed peer: ");
                console.log(peerObj);

                // Data sample
                // {
                //     "cladNetID":"cladnet1",
                //     "hostID": "2",
                //     "privateIPv4Network": "xxx.xxx.xxx.2/yy",
                //     "privateIPv4Address": "xxx.xxx.xxx.2",
                //     "publicIPv4Address": "aaa.aaa.aaa.aaa"
                // };

                updateNetworkingRuleTable(peerObj);

                updateChartData(peerObj);

                break;

            case "NetworkStatus":
                console.log("NetworkStatus:");
                console.log(msg.text);
                let networkStatus = JSON.parse(msg.text);
                console.log("Parsed NetworkStatus: ");
                console.log(networkStatus);

                //{"interHostNetworkStatus":[
                //    {"sourceIP":"172.16.0.2","sourceID":"ns01-kimy-c8jfasqhfuoal23fngkg","destinationIP":"172.16.0.3","destinationID":"ip-192-168-2-137","minimunRTT":0.183840987,"averageRTT":0.184160238,"maximumRTT":0.184511296,"stddevRTT":0.000274575,"packetsReceive":3,"packetLoss":0,"bytesReceived":72},
                //    {"sourceIP":"172.16.0.2","sourceID":"ns01-kimy-c8jfasqhfuoal23fngkg","destinationIP":"172.16.0.4","destinationID":"ns01-kimy-c8jfaqihfuoal23fngk0","minimunRTT":0.153647747,"averageRTT":0.154345125,"maximumRTT":0.154826914,"stddevRTT":0.000504953,"packetsReceive":3,"packetLoss":0,"bytesReceived":72}
                //  ]
                //}

                updateNetworkStatusTable(networkStatus.interHostNetworkStatus);

                updateChordDiagram(networkStatus.interHostNetworkStatus);

                break;

            default:
                console.log("Unknown type of message");
        }

    }

    function updateCLADNetTable(list) {
        let elemCLADNetData = document.getElementById("cladnet-data");

        // This table show a list of Cloud Adaptive Network
        let tbody = '';
        for (let i = 0; i < list.length; i++) {
            tbody += ('<tr>' +
                '<td class="align-center">' + list[i].id + '</td>' +
                '<td class="align-center">' + list[i].name + '</td>' +
                '<td class="align-center">' + list[i].ipv4AddressSpace + '</td>' +
                '<td class="align-center">' + list[i].description + '</td>' +
                '</tr>');
        }
        elemCLADNetData.innerHTML = tbody;
    }

    function updateCLADNetDropdownList(list) {
        let elems = document.getElementsByClassName("cladnet-id-dropdown-elem");

        for (var i=0; i<elems.length; i++) {
            elems[i].innerHTML = '';
            elems[i].innerHTML += '<option value="" selected disabled hidden>Choose here</option>';

            for (let j = 0; j < list.length; j++) {
                elems[i].innerHTML += '<option value="' + list[j].id + '">' + list[j].id + '</option>';
            }
        }
    }

    function updateNetworkingRuleTable(json) {
        // for (let i = 0; i < json.hostID.length; i++) {
        let elemPeer = document.getElementById(json.hostID);
        if (elemPeer) {
            elemPeer.children[0].innerText = json.hostID;
            elemPeer.children[1].innerText = json.privateIPv4Network;
            elemPeer.children[2].innerText = json.privateIPv4Address;
            elemPeer.children[3].innerText = json.publicIPv4Address;
            elemPeer.children[4].innerText = json.state;
        } else {
            let elemNetworkingRuleData = document.getElementById("net-rule-data");
            elemNetworkingRuleData.innerHTML += ('<tr id="' + json.hostID + '" class="' + json.cladNetID + '">' +
                '<td class="align-center">' + json.hostID + '</td>' +
                '<td class="align-center">' + json.privateIPv4Network + '</td>' +
                '<td class="align-center">' + json.privateIPv4Address + '</td>' +
                '<td class="align-center">' + json.publicIPv4Address + '</td>' +
                '<td class="align-center">' + json.state + '</td>' +
                '</tr>');
        }
        // }
    }

    function updateChartData(peer) {

        // Check if the CLADNet is included.
        let includedCLADNet = false;
        let objIndex = -1;
        for (let i = 0; i < chartDataFrame.series.length; i++) {
            let objName = "CLADNet " + peer.cladNetID;
            if (chartDataFrame.series[i].name == objName) {
                includedCLADNet = true;
                objIndex = i;
                break;
            }
        }

        if (includedCLADNet) {
            let existingCLADNet = chartDataFrame.series[objIndex];

            // find the peer                
            let peerIndex = existingCLADNet.data.findIndex(function(item) {
                return item.name === peer.hostID
            }); // findIndex = find + indexOf
            
            // if included
            if (peerIndex > -1){
                switch (peer.state) {
                    case "running":
                        // update the peer info                      
                        existingCLADNet.data[peerIndex].network = peer.privateIPv4Network + " - " + peer.publicIPv4Address;
                        
                    case "suspended": 
                        // remove the peer info
                        existingCLADNet.data.splice(peerIndex, 1);
                    default:
                        console.log("unknown state of " + peer.hostID)
                }                    
            } else { 
                if (peer.state == "running"){
                    // add the new peer
                    existingCLADNet.data.push({
                        name: peer.hostID,
                        value: Math.floor(Math.random() * 30 + 1),
                        network: peer.privateIPv4Network + " - " + peer.publicIPv4Address
                    });
                }
            }
        } else {
            let obj = {
                name: "CLADNet " + peer.cladNetID,
                data: []
            };

            if (peer.state == "running"){
                obj.data.push({
                    name: peer.hostID,
                    value: Math.floor(Math.random() * 30 + 1),
                    network: peer.privateIPv4Network + " - " + peer.publicIPv4Address
                });
            }
            
            chartDataFrame.series.push(obj);
        }
        // Update chart
        Highcharts.chart('container', chartDataFrame);
    }


    let unitCalibration = 1000;

    function updateNetworkStatusTable(interHostNetworkStatus) {

        let elemCLADNetData = document.getElementById("network-status-data");

        let len = interHostNetworkStatus.length;
        console.log(len);

        // This table shows a list of the network status
        for (let i = 0; i < len; i++) {

            let sourceIP = interHostNetworkStatus[i].sourceIP;
            let sourceID = interHostNetworkStatus[i].sourceID;
            let destinationIP = interHostNetworkStatus[i].destinationIP;
            let destinationID = interHostNetworkStatus[i].destinationID;
            let averageRTT = parseFloat(interHostNetworkStatus[i].averageRTT);

            // Check if there is network status from source to destination and vice versa
            let index = networkStatusArray.findIndex(function(item) {
                return ((item.from == sourceIP && item.to == destinationIP) ||
                (item.from == destinationIP && item.to == sourceIP))
            });

            console.log("index: " + index);
            
            // If not exist, push it
            if (index == -1) { 
                let src = sourceIP + " (" + sourceID + ")";
                let des = destinationIP + " (" + destinationID + ")";
                let latency = (averageRTT * unitCalibration).toFixed(2);

                let row = ('<tr>' +
                    '<td class="align-center">' + src + '</td>' +
                    '<td class="align-center">' + des + '</td>' +
                    '<td class="align-center">' + latency + '</td>' +
                '</tr>');

                console.log(row);
                elemCLADNetData.innerHTML += row;
            }
        }
    }

    function updateChordDiagram(interHostNetworkStatus){
        let len = interHostNetworkStatus.length;

        console.log(len);

        for (let i = 0; i < len; i++) {
            let sourceIP = interHostNetworkStatus[i].sourceIP;
            // let sourceID = interHostNetworkStatus[i].sourceID;
            let destinationIP = interHostNetworkStatus[i].destinationIP;
            // let destinationID = interHostNetworkStatus[i].destinationID;
            let averageRTT = parseFloat(interHostNetworkStatus[i].averageRTT);            

            // Check if there is network status from source to destination and vice versa
            let index = networkStatusArray.findIndex(function(item) {
                return ((item.from == sourceIP && item.to == destinationIP) ||
                (item.from == destinationIP && item.to == sourceIP))                
            });
            
            // If not exist, push it
            if (index == -1) { 
                let src = sourceIP; // + " (" + sourceID + ")";
                let des = destinationIP; // + " (" + destinationID + ")";
                let latency = (averageRTT * unitCalibration).toFixed(2);

                networkStatusArray.push({
                    from: src,
                    to: des,
                    value: latency
                });
            }            
        }

        console.log(networkStatusArray);
        series.data.setAll(networkStatusArray);

        // Make stuff animate on load
        series.appear(1000, 100);
    }


</script>

<script type="text/javascript">
    chartDataFrame = {
        chart: {
            type: 'packedbubble',
            height: '100%'
        },
        title: {
            text: 'The Cloud Adaptive Networks'
        },
        tooltip: {
            useHTML: true,
            pointFormat: '<b>{point.name}:</b> {point.network}'
        },
        plotOptions: {
            packedbubble: {
                minSize: '20%',
                maxSize: '100%',
                zMin: 0,
                zMax: 1000,
                layoutAlgorithm: {
                    gravitationalConstant: 0.05,
                    splitSeries: true,
                    seriesInteraction: false,
                    dragBetweenSeries: true,
                    parentNodeLimit: true
                },
                dataLabels: {
                    enabled: true,
                    format: '{point.name}',
                    filter: {
                        property: 'y',
                        operator: '>',
                        value: 0
                    },
                    style: {
                        color: 'black',
                        textOutline: 'none',
                        fontWeight: 'normal'
                    }
                }
            }
        },
        series: []
    };

</script>

<script type="text/javascript">

    var root = am5.Root.new("chartdiv");

    // Set themes
    // https://www.amcharts.com/docs/v5/concepts/themes/
    root.setThemes([am5themes_Animated.new(root)]);

    // Create series
    // https://www.amcharts.com/docs/v5/charts/flow-charts/
    var series = root.container.children.push(
        am5flow.ChordDirected.new(root, {
            sourceIdField: "from",
            targetIdField: "to",
            valueField: "value",
            sort: "ascending",
            linkHeadRadius: null,
            padAngle: 7,
            nodeWidth: 15
        })
    );

    series.links.template.setAll({
        fillStyle:"gradient",
        fillOpacity: 0.25
    });

    series.nodes.get("colors").set("step", 2);

    series.bullets.push(function (_root, _series, dataItem) {
        var bullet = am5.Bullet.new(root, {
            locationY: Math.random(),
            sprite: am5.Circle.new(root, {
            radius: 5,
            fill: dataItem.get("source").get("fill")
            })
        });

        bullet.animate({
            key: "locationY",
            to: 1,
            from: 0,
            duration: Math.random() * 1000 + 2000,
            loops: Infinity,
            easing: am5.ease.yoyo(am5.ease.cubic)
        });

        return bullet;
    });

    series.nodes.labels.template.setAll({
        textType: "regular",
        fontSize: "1.1em",
        radius: 20
        // fill: root.interfaceColors.get("background"),
    });

    // series.nodes.bullets.push(function (_root, _series, dataItem) {
    //     return am5.Bullet.new(root, {
    //         sprite: am5.Circle.new(root, {
    //         radius: 30,
    //         fill: dataItem.get("fill")
    //         })
    //     });
    // });

    series.children.moveValue(series.bulletsContainer, 0);

</script>

<!-- Scripts -->
<script src="/introspect/assets/js/jquery.min.js"></script>
<script src="/introspect/assets/js/skel.min.js"></script>
<script src="/introspect/assets/js/util.js"></script>
<script src="/introspect/assets/js/main.js"></script>

</body>
</html>
